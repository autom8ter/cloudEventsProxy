syntax = "proto3";

package stategate;

option go_package = "stategate";

import "google/api/annotations.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/any.proto";
import "google/protobuf/empty.proto";
import "github.com/mwitkow/go-proto-validators/validator.proto";

// A pluggable API and "Application State Gateway" that enforces the [Event Sourcing Pattern](https://microservices.io/patterns/data/event-sourcing.html) for securely persisting & broadcasting application state changes
service StateGateService {
  // SetObject sets the current state value of an object, adds it to the event log, then broadcast the event to all interested consumers
  rpc SetObject(Object) returns(google.protobuf.Empty){
    option (google.api.http) = {
      post: "/api/{tenant}/{type}/state/{key}"
    };
  }
  // GetObject gets an object's current state values
  rpc GetObject(ObjectRef) returns(Object){
    option (google.api.http) = {
      get: "/api/{tenant}/{type}/state/{key}"
    };
  }
  // SearchObjects queries objects of a specific type
  rpc SearchObjects(SearchObjectOpts) returns(Objects){
    option (google.api.http) = {
      get: "/api/{tenant}/{type}/state"
    };
  }
  // DelObject hard deletes an object & all of it's events
  rpc DelObject(ObjectRef) returns(google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/api/{tenant}/{type}/state"
    };
  }
  // StreamEvents creates an event stream/subscription to a given object type until fn returns false OR the context cancels.
  // Event Consumers invoke this method.
  rpc StreamEvents(StreamOpts) returns(stream Event){
    option (google.api.http) = {
      get: "/api/{tenant}/{type}/events/stream"
    };
  }
  // SearchEvents queries events related to a specific object.
  rpc SearchEvents(SearchEventOpts) returns(Events){
    option (google.api.http) = {
      get: "/api/{tenant}/{type}/events"
    };
  }
}

// ObjectRef is a reference to an existing object
message ObjectRef {
  // the object's tenant(ex: acme)
  string tenant =1[(validator.field) = {regex : "^\\S+$"}];
  // Object type (ex: user)
  string type =2[(validator.field) = {regex : "^\\S+$"}];
  // Object key (unique within type)
  string key =3[(validator.field) = {regex : "^\\S+$"}];
}

// Object hold's the current state of an object
message Object {
  // the object's tenant(ex: acme)
  string tenant =1[(validator.field) = {regex : "^\\S+$"}];
  // Object type (ex: user)
  string type =2[(validator.field) = {regex : "^\\S+$"}];
  // Object key (unique within type)
  string key =3[(validator.field) = {regex : "^\\S+$"}];
  // Object values (structured k/v pairs)
  google.protobuf.Struct values = 4[(validator.field) = {msg_exists : true}];
}

// Objects is an array of Object
message Objects {
  repeated Object objects =1;
}

// SearchObjectOpts are options when querying historical events for a given object
message SearchObjectOpts {
  // the object's tenant(ex: acme)
  string tenant =1[(validator.field) = {regex : "^\\S+$"}];
  // Object type (ex: user)
  string type =2[(validator.field) = {regex : "^\\S+$"}];
  // filter records that match k/v pairs
  google.protobuf.Struct match_values = 3;
  // limit returned objects
  int64 limit =4[(validator.field) = {int_gt : 0}];
  // offset returned events(pagination)
  int64 offset =5;
}

// SearchEventOpts are options when querying historical events for a given object
message SearchEventOpts {
  // the object's tenant(ex: acme)
  string tenant =1[(validator.field) = {regex : "^\\S+$"}];
  // Object type (ex: user)
  string type =2[(validator.field) = {regex : "^\\S+$"}];
  // filter events belonging to a particular object
  string key = 3;
  // only return object events that occurred after specified min timestamp
  int64 min = 4;
  // only return object events that occurred before specified max timestamp
  int64 max = 5;
  // limit returned object events
  int64 limit =6[(validator.field) = {int_gt : 0}];
  // offset returned object events(pagination)
  int64 offset =7;
}

// StreamOpts are options for consumers looking to stream events
message StreamOpts {
  // the tenant of the object (ex: acme) that triggered the event
  string tenant =1[(validator.field) = {regex : "^\\S+$"}];
  // the type of the object (ex: user) that triggered the event
  string type =2[(validator.field) = {regex : "^\\S+$"}];
}

// Event is primitive that represents a single state change to an object, who triggered it, and the time it occurred.
// Events are persisted to history & broadcasted to interested consumers(Stream) any time an object is created/modified
message Event {
  // Identifies the event(uuid).
  string id = 1[(validator.field) = {uuid_ver : 0}];
  // the unmodified
  Object object = 2[(validator.field) = {msg_exists : true}];
  // The authentication claims of the event producer.
  google.protobuf.Struct claims =3[(validator.field) = {msg_exists : true}];
  // Timestamp(ns) of when the event was received.
  int64 time =4[(validator.field) = {int_gt : 0}];
}

// Events is an array of events
message Events {
  repeated Event events =1;
}
