# stategate

A secure pluggable API that enforces the [Event Sourcing Pattern](https://microservices.io/patterns/data/event-sourcing.html) for persisting & broadcasting application state changes

![Event-Sourcing](./stategate.png)


[![GoDoc](https://godoc.org/github.com/autom8ter/stategate?status.svg)](https://godoc.org/github.com/autom8ter/stategate/stategate-client-go)

- [API Documentation](https://autom8ter.github.io/stategate/)
                                        
## Features
- [x] [4 simple API Methods](https://github.com/autom8ter/stategate/blob/master/schema.proto#L15) for interacting with application state: `SetObject, GetObject, StreamEvents, SearchEvents`
- [x] Capture all changes to an application state as a sequence of events.
- [x] Native [gRPC](https://grpc.io/) support
    - [protobuf schema](schema.proto)
- [x] Embedded REST support `/` (transcoding)
    - [open api schema](schema.swagger.json)
- [x] Embedded [grpcweb](https://grpc.io/docs/platforms/web/basics/) support (transcoding)
- [x] Metrics Server(prometheus/pprof)
- [x] Authentication - JWT/OAuth with remote [JWKS](https://auth0.com/docs/tokens/json-web-tokens/json-web-key-sets) verification
- [x] Authorization - [Rego](https://www.openpolicyagent.org/docs/latest/policy-language/) based Authorization engine
- [x] Autogenerated Client gRPC SDK's
    - [x] Go
        - [![GoDoc](https://godoc.org/github.com/autom8ter/stategate?status.svg)](https://godoc.org/github.com/autom8ter/stategate/stategate-client-go)
    - [x] [Node](./gen/grpc/node)
    - [x] [PHP](./gen/grpc/php)
    - [x] [C#](./gen/grpc/csharp)
    - [x] [Java](./gen/grpc/java)
    - [x] [gRPC Web](./gen/grpc/web)
    - [ ] Python
    - [ ] Ruby
- [x] Structured JSON Logs
- [x] [Sample Kubernetes Manifest](k8s.yaml)
- [x] Pluggable "Channel" Providers
    - [x] Nats
    - [x] Nats Streaming(Stan)
    - [x] Redis
    - [x] Kafka
    - [ ] RabbitMQ
    - [ ] Google PubSub
    - [ ] AWS SQS
    - [ ] Azure Queue
- [x] Pluggable "Storage" Providers
    - [x] MongoDb
    - [ ] PostgreSQL
    - [ ] MySQL
    - [ ] Cassandra

## Concepts

## Goals

- [x] Create a simple API interface for storing state and and subscribing to state changes(events) using pluggable channel & storage providers
- [x] Capture all changes to an application state as a sequence of events.
- [x] Safe to swap backend providers without changing client-side code
- [x] Type-safe client's generated in many languages
- [x] Safe to expose to the public internet due to fine-grained authentication/authorization model.
- [x] Different combinations of Channel & Storage Providers are interoperable.
- [x] Capture a persistant, immutable historical record of all state changes using a pluggable storage provider
- [x] Store identity(jwt.claims) & timestamp in event logs to capture who is changing what & when

## Command Line

```
stategate -h
Usage of stategate:
      --config string   path to config file (env: STATEGATE_CONFIG) (default "config.yaml")
```

## Sample Config

```yaml

# port to serve on. metrics server is started on this port+1 if enabled
port: 8080
cors:
  allowed_origins:
    - "*"
  allowed_methods:
    - "POST"
    - "PUT"
    - "GET"
    - "OPTIONS"
  allowed_headers:
    - "*"
#tls:
#  cert_file: "/tmp/server.cert"
#  key_file: "/tmp/server.key"
logging:
  # enable debug logs
  debug: true


backend:
  # pluggable channel providers: [inmem, redis, nats, stan, kafka, google-pubsub, aws-sqs]
  channel_provider:
    name: "nats"
    config:
      addr: "0.0.0.0:4444"
#     client_cert_file: "/tmp/nats.cert"
#     client_key_file: "/tmp/nats.key"
#  channel_provider:
#    name: "redis"
#    config:
#      addr: "0.0.0.0:6379"
#      user: "default"
#      password: "admin1234"
#      client_cert_file: "/tmp/redis.cert"
#      client_key_file: "/tmp/redis.key"

#  channel_provider:
#    name: "stan"
#    config:
#      addr: "0.0.0.0:4444"
#      client_cert_file: "/tmp/stan.cert"
#      client_key_file: "/tmp/stan.key"

# pluggable storage providers: [mongo, elasticsearch]
  
  storage_provider:
    name: "mongo"
    config:
      addr: "mongodb://localhost:27017/testing"
      database: "testing"
#      client_cert_file: "/tmp/mongo.cert"
#      client_key_file: "/tmp/mongo.key"



# authentication options
authentication:
  # json web keys uri for authentication.
  # if empty, inbound jwt's will not be verified.
  jwks_uri: ""

# authorization options
authorization:
  requests: |
    package stategate.authz

    default allow = false

    allow {
      input.claims.sub = "1234567890"
      input.claims.name = "John Doe"
    }
  responses: |
    package stategate.authz

    default allow = true

```

## Notes
